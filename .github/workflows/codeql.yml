name: "CodeQL"

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    schedule:
        -   cron: '0 6 * * 1'

jobs:
    analyze:
        name: Analyze
        runs-on: ubuntu-latest
        permissions:
            actions: read
            contents: read
            security-events: write

        steps:
            -   name: Checkout repository
                uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v4

            -   name: Set up JDK 21
                uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # ratchet:actions/setup-java@v4
                with:
                    distribution: 'temurin'
                    java-version: '21'
                    cache: 'maven'

            -   name: Initialize CodeQL
                uses: github/codeql-action/init@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # ratchet:github/codeql-action/init@v3
                with:
                    languages: java-kotlin
                    build-mode: manual

            -   name: Build with Maven (CodeQL compatible Kotlin version)
                env:
                    GITHUB_USERNAME: x-access-token
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    mvn clean compile -DskipTests \
                      -Dkotlin.version=2.1.20 \
                      --settings .m2/maven-settings.xml \
                      --batch-mode --errors

            -   name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # ratchet:github/codeql-action/analyze@v3
                with:
                    category: "/language:java-kotlin"
