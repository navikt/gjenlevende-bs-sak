name: "CodeQL"

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    schedule:
        -   cron: '0 6 * * 1'

jobs:
    analyze:
        name: Analyze
        runs-on: ubuntu-latest
        permissions:
            actions: read
            contents: read
            security-events: write

        steps:
            -   name: Checkout repository
                uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v4

            -   name: Set up JDK 21
                uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # ratchet:actions/setup-java@v4
                with:
                    distribution: 'temurin'
                    java-version: '21'
                    cache: 'maven'

            -   name: Initialize CodeQL
                uses: github/codeql-action/init@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # ratchet:github/codeql-action/init@v3
                with:
                    languages: java-kotlin
                    build-mode: manual

            -   name: Build with Maven (CodeQL compatible Kotlin version)
                env:
                    GITHUB_USERNAME: x-access-token
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    mvn clean compile -DskipTests \
                      -Dkotlin.version=2.1.20 \
                      --settings .m2/maven-settings.xml \
                      --batch-mode --errors

            -   name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # ratchet:github/codeql-action/analyze@v3
                with:
                    category: "/language:java-kotlin"
