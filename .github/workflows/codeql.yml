name: "CodeQL"

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    schedule:
        -   cron: '0 6 * * 1'

jobs:
    analyze:
        name: Analyze
        runs-on: ubuntu-latest
        permissions:
            actions: read
            contents: read
            security-events: write

        steps:
            -   name: Checkout repository
                uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # ratchet:actions/checkout@v4

            -   name: Set up JDK 21
                uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # ratchet:actions/setup-java@v4
                with:
                    distribution: 'temurin'
                    java-version: '21'
                    cache: 'maven'

            -   name: Initialize CodeQL
                uses: github/codeql-action/init@ea9e4e37992a54ee68a9571571f2c252b5b37a4a # ratchet:github/codeql-action/init@v3
                with:
                    languages: java-kotlin
                    build-mode: manual

            -   name: Build with Maven (CodeQL compatible Kotlin version)
                env:
                    GITHUB_USERNAME: x-access-token
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    mvn clean compile -DskipTests \
                      -Dkotlin.version=2.1.20 \
                      --settings .m2/maven-settings.xml \
                      --batch-mode --errors

            -   name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@ea9e4e37992a54ee68a9571571f2c252b5b37a4a # ratchet:github/codeql-action/analyze@v3
                with:
                    category: "/language:java-kotlin"
