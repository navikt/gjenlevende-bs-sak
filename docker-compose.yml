services:
    # Shared: PostgreSQL (brukes av b√•de mock og dev profiler)
    postgres:
        image: postgres:17
        container_name: gjenlevende-bs-sak-postgres-1
        profiles: ["mock", "dev"]
        ports:
            - "5432:5432"
        environment:
            POSTGRES_DB: gjenlevende-bs-sak
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: test
        volumes:
            - postgres-data:/var/lib/postgresql/data
        labels:
            - "com.docker.compose.project=gjenlevende-bs-sak"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 5s
            timeout: 5s
            retries: 5

    # Mock profil: OAuth2 mock server
    mock-oauth2-server:
        image: ghcr.io/navikt/mock-oauth2-server:2.1.10
        container_name: gjenlevende-bs-sak-mock-oauth2-1
        profiles: ["mock"]
        ports:
            - "8089:8080"
        environment:
            LOG_LEVEL: INFO
        labels:
            - "com.docker.compose.project=gjenlevende-bs-sak"

    # Mock profil: WireMock for integrasjonsmocks
    wiremock:
        image: wiremock/wiremock:3.13.2
        container_name: gjenlevende-bs-sak-wiremock-1
        profiles: ["mock"]
        ports:
            - "8090:8080"
        volumes:
            - ./wiremock:/home/wiremock
        command: --verbose --global-response-templating
        labels:
            - "com.docker.compose.project=gjenlevende-bs-sak"

    # Dev profil: Texas (ekte Azure AD token exchange)
    texas:
        image: ghcr.io/nais/texas:latest
        container_name: gjenlevende-bs-sak-texas-1
        profiles: ["dev"]
        ports:
            - "7575:7575"
        environment:
            BIND_ADDRESS: "0.0.0.0:7575"
            AZURE_ENABLED: "true"
            TEXAS_HTTP_CONNECT_TIMEOUT_MILLIS: "10000"
            TEXAS_HTTP_READ_TIMEOUT_MILLIS: "10000"
            TEXAS_HTTP_OVERALL_TIMEOUT_MILLIS: "10000"
            AZURE_APP_CLIENT_ID: ${AZURE_APP_CLIENT_ID}
            AZURE_APP_CLIENT_SECRET: ${AZURE_APP_CLIENT_SECRET}
            AZURE_APP_TENANT_ID: ${AZURE_APP_TENANT_ID}
            AZURE_APP_JWK: ${AZURE_APP_JWK}
            AZURE_OPENID_CONFIG_ISSUER: https://login.microsoftonline.com/${AZURE_APP_TENANT_ID}/v2.0
            AZURE_OPENID_CONFIG_TOKEN_ENDPOINT: https://login.microsoftonline.com/${AZURE_APP_TENANT_ID}/oauth2/v2.0/token
            AZURE_OPENID_CONFIG_JWKS_URI: https://login.microsoftonline.com/${AZURE_APP_TENANT_ID}/discovery/v2.0/keys
        restart: on-failure
        labels:
            - "com.docker.compose.project=gjenlevende-bs-sak"

volumes:
    postgres-data:
