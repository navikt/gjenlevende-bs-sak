services:
    texas:
        image: ghcr.io/nais/texas:latest
        ports:
            - "7575:7575"
        environment:
            BIND_ADDRESS: "0.0.0.0:7575"
            AZURE_ENABLED: "true"
            # Increase timeouts for stability
            TEXAS_HTTP_CONNECT_TIMEOUT_MILLIS: "10000"
            TEXAS_HTTP_READ_TIMEOUT_MILLIS: "10000"
            TEXAS_HTTP_OVERALL_TIMEOUT_MILLIS: "10000"
            # Azure AD configuration
            AZURE_APP_CLIENT_ID: ${AZURE_APP_CLIENT_ID}
            AZURE_APP_CLIENT_SECRET: ${AZURE_APP_CLIENT_SECRET}
            AZURE_APP_TENANT_ID: ${AZURE_APP_TENANT_ID}
            AZURE_OPENID_CONFIG_ISSUER: https://login.microsoftonline.com/${AZURE_APP_TENANT_ID}/v2.0
            AZURE_OPENID_CONFIG_TOKEN_ENDPOINT: https://login.microsoftonline.com/${AZURE_APP_TENANT_ID}/oauth2/v2.0/token
            AZURE_OPENID_CONFIG_JWKS_URI: https://login.microsoftonline.com/${AZURE_APP_TENANT_ID}/discovery/v2.0/keys
        restart: on-failure

    unleash:
        image: unleashorg/unleash-server:latest
        ports:
            - "4242:4242"
        environment:
            DATABASE_URL: "postgres://unleash:unleash@unleash-db:5432/unleash"
            DATABASE_SSL: "false"
            LOG_LEVEL: "warn"
            INIT_ADMIN_API_TOKENS: "*:*.unleash-insecure-api-token"
        depends_on:
            - unleash-db
        restart: on-failure

    unleash-db:
        image: postgres:17-alpine
        environment:
            POSTGRES_DB: unleash
            POSTGRES_USER: unleash
            POSTGRES_PASSWORD: unleash
        volumes:
            - unleash-db-data:/var/lib/postgresql/data

volumes:
    unleash-db-data:
